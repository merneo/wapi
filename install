#!/usr/bin/env bash
set -euo pipefail

REPO_URL="https://github.com/merneo/wapi"
ARCHIVE_URL="${REPO_URL}/archive/refs/heads/master.zip"

log() { printf '==> %s\n' "$*"; }
err() { printf '!! %s\n' "$*" >&2; }

need() {
  command -v "$1" >/dev/null 2>&1 || { err "Missing dependency: $1"; exit 1; }
}

install_with_pipx() {
  log "Installing via pipx from master archive"
  pipx install --force "wapi @ ${ARCHIVE_URL}"
  log "Done. Binary: $(pipx list | awk '/package wapi/ {print $3}')"
}

install_with_venv() {
  need "python3"
  local root="${HOME}/.local/wapi"
  local venv="${root}/venv"
  mkdir -p "${root}"

  ensure_venv_prereqs() {
    if command -v apt-get >/dev/null 2>&1; then
      local SUDO=""
      if [ "$(id -u)" -ne 0 ] && command -v sudo >/dev/null 2>&1; then
        SUDO="sudo"
      fi
      log "Attempting to install python3-venv/python3-pip via apt-get"
      ${SUDO} apt-get update -y || true
      # Try version-specific venv first, then generic
      pyver="$(python3 -c 'import sys; print(f\"{sys.version_info.major}.{sys.version_info.minor}\")' 2>/dev/null || echo 3)"
      ${SUDO} apt-get install -y "python${pyver}-venv" python3-venv python3-pip || true
      ${SUDO} apt-get install -y pipx || true
    else
      err "Missing ensurepip/venv. Install python3-venv (or pipx) and rerun."
      exit 1
    fi
  }

  log "Creating venv at ${venv}"
  if ! python3 -m venv "${venv}"; then
    err "venv creation failed (likely missing python3-venv/ensurepip)"
    ensure_venv_prereqs
    log "Retrying venv creation"
    python3 -m venv "${venv}" || { err "venv creation still failing. Install python3-venv manually."; exit 1; }
  fi
  # shellcheck disable=SC1090
  source "${venv}/bin/activate"
  log "Upgrading pip and installing from master archive"
  pip install --upgrade pip
  pip install "wapi @ ${ARCHIVE_URL}"
  mkdir -p "${HOME}/.local/bin"
  local shim="${HOME}/.local/bin/wapi"
  cat > "${shim}" <<'EOS'
#!/usr/bin/env bash
exec "${HOME}/.local/wapi/venv/bin/wapi" "$@"
EOS
  chmod +x "${shim}"
  log "Done. Binary: ${shim}"
  log "Ensure ~/.local/bin is on your PATH"
}

main() {
  need "curl"
  need "unzip"
  if command -v pipx >/dev/null 2>&1; then
    install_with_pipx
  else
    install_with_venv
  fi
}

main "$@"
